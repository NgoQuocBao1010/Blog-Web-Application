{% load static %}
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Posts</title>

        <!-- Font awesome -->
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
        />

        <!-- CSS -->
        <link rel="stylesheet" href="{% static './css/post.css' %}" />
    </head>
    <body>
        <!--  header  -->
        {% include "navbar.html" %}

        <!-- posts  -->
        <section class="container" id="posts">
            <div class="posts-container">
                <!-- Post content -->
                <div class="post">
                    <p class="path">
                        <a href="{% url 'home' %}">
                            <span title="home_path">Home /</span>
                        </a>
                        <span>{{ post.title }}</span>
                    </p>

                    <!-- post block -->
                    <h3 class="title">{{ post.title }}</h3>
                    <div class="date">
                        <span>By {{ post.author }} /</span>
                        <span>{{ post.dateCreated }} /</span>
                        <span>{{ post.comment_set.all|length }}</span>
                        <i class="far fa-comment"></i>
                    </div>
                    <hr />
                    <a href="#">
                        <img
                            src="{{ post.coverImage.url }}"
                            alt=""
                            class="image"
                        />
                    </a>

                    <p class="text">{{ post.content }}</p>

                    <!-- Comments block -->
                    <div class="comments-list">
                        <span id="total-comment">{{ post.comment_set.all|length }} Comments</span>

                        <!-- specific commented -->
                        {% for comment in post.comment_set.all %}
                        <div class="commented" id="comment-{{ comment.id }}">
                            <i class="far fa-comment"></i>

                            {% if request.user == comment.commentor or request.user == post.author %}
                            <i class="fas fa-trash delete-comment" data-id="{{ comment.id }}"></i>
                            {% endif %} 
                            
                            {% if comment.commentor %}
                            <span>
                                By
                                <a
                                    href="{% url 'bloggerHome' comment.commentor.email  %}"
                                >
                                    {{ comment.commentor }}
                                </a>
                                /
                            </span>
                            {% else %}
                            <span> By Guest /</span>
                            {% endif %}

                            <span>{{ comment.dateCreated }}</span>
                            <p id="comment-{{ comment.id }}">
                                {{ comment.content }}
                            </p>

                            <a href=""></a>
                        </div>
                        {% empty %}
                        <p id="no-comment">No comments yet.</p>
                        {% endfor %}
                    </div>

                    <!-- Comment form -->
                    <span class="leave_comment">Comment here</span>
                    <div class="comment-block">
                        <form
                            action=""
                            method="POST"
                            class="comment-form"
                            id="comment-form"
                        >
                            <textarea
                                id="content"
                                name="content"
                                class="comment"
                                placeholder="Type your comment here."
                            ></textarea>
                            <button id="comment_submit" type="submit" class="">
                                Post comment
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- sidebar -->
            <div class="sidebar">
                <!-- User box -->
                <div class="box">
                    <h3 class="title">Author</h3>
                    <div class="about">
                        <img
                            src="{{ post.author.profile.avatar.url }}"
                            alt=""
                        />
                        <h3>{{ post.author.profile.name }}</h3>
                        <p>{{ post.author }}</p>

                        <div class="follow">
                            <a href="#" class="fab fa-facebook-f"></a>
                            <a href="#" class="fab fa-twitter"></a>
                            <a href="#" class="fab fa-instagram"></a>
                            <a href="#" class="fab fa-youtube"></a>
                        </div>
                    </div>
                </div>

                <!-- categories -->
                <div class="box">
                    <h3 class="title">categories</h3>
                    <div class="category">
                        {% for category in categories %}
                        <a href="#">
                            {{ category.name }}
                            <span>{{ category.post_set.all|length }}</span>
                        </a>
                        {% endfor %}
                    </div>
                </div>

                <!-- Popular posts -->
                <div class="box">
                    <h3 class="title">popular posts</h3>
                    <div class="p-post">
                        {% for post in popularPosts %}
                        <a href="{% url 'postDetail' post.id %}">
                            <h3>{{ forloop.counter }}. {{ post.title }}</h3>
                            <span>
                                <i class="far fa-clock"></i>
                                {{ post.dateCreated }}
                            </span>
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </section>

        <!-- posts have same category  -->
        <section class="multi-posts" id="multi-posts">
            <h3 class="title">RELATED POSTS</h3>

            <!-- 1 slide has 3 posts -->
            <!-- 1st slide -->
            <div class="single_post">
                <table cellspacing="7">
                    <tr>
                        <td>
                            <a href="">
                                <img
                                    src="{% static './images/posts/blog1.jpg' %}"
                                />
                            </a>
                            <h3>Place to travel</h3>
                        </td>
                        <td>
                            <a href="">
                                <img
                                    src="{% static './images/posts/blog2.jpg' %}"
                                />
                            </a>
                            <h3>Recipe</h3>
                        </td>
                        <td>
                            <a href="">
                                <img
                                    src="{% static './images/posts/blog1.jpg' %}"
                                />
                            </a>
                            <h3>Place to travel</h3>
                        </td>
                    </tr>
                </table>
            </div>
            <!-- 2nd slide -->
            <div class="single_post">
                <table cellspacing="7">
                    <tr>
                        <td>
                            <a href="">
                                <img
                                    src="{% static './images/posts/blog1.jpg' %}"
                                />
                            </a>
                            <h3>Place to travel</h3>
                        </td>
                        <td>
                            <a href="">
                                <img
                                    src="{% static './images/posts/blog1.jpg' %}"
                                />
                            </a>
                            <h3>Recipe</h3>
                        </td>
                        <td>
                            <a href="">
                                <img
                                    src="{% static './images/posts/blog1.jpg' %}"
                                />
                            </a>
                            <h3>Place to travel</h3>
                        </td>
                    </tr>
                </table>
            </div>

            <button id="left" onclick="plusDivs(-1)">
                <i class="fas fa-chevron-left fa-2x"></i>
            </button>
            <button id="right" onclick="plusDivs(1)">
                <i class="fas fa-chevron-right fa-2x"></i>
            </button>
        </section>

        <!-- footer -->
        <section class="footer">
            <div class="follow">
                <a href="#" class="fab fa-facebook-f"></a>
                <a href="#" class="fab fa-twitter"></a>
                <a href="#" class="fab fa-instagram"></a>
                <a href="#" class="fab fa-youtube"></a>
            </div>

            <div class="credit">All rights reserved</div>
        </section>

        <!-- Javascript  -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="{% static './js/slideshow.js' %}"></script>
        <script src="{% static './js/dropdown.js' %}"></script>

        <script>
            const postId = JSON.parse("{{ post.id }}");

            const countComments = () => {
                /* Count number of comments */
                const numberOfComments = $('.commented').length;
                $("#total-comment").html(`${numberOfComments} Comments`);

                if (!numberOfComments) $("#no-comment").show();
                else $("#no-comment").hide();
            }

            $(document).ready(function () {
                // using ajax
                $("#comment-form").submit(function (e) {
                    // preventing from page reload
                    e.preventDefault();

                    const content = $("#content").val();
                    const serializedData = {
                        content,
                        postId,
                    };

                    // make POST ajax call
                    $.ajax({
                        type: "POST",
                        url: "http://127.0.0.1:8000/post/ajax/comment",
                        data: serializedData,

                        success: function (response) {
                            // console.log(response);
                            const {
                                commentor,
                                commentId,
                                content,
                                dateCreated,
                                bloggerUrl,
                            } = response;
                            // clear the form.
                            $("#comment-form").trigger("reset");

                            // url link
                            const urlLink = bloggerUrl
                                ? `<span> By <a href="${bloggerUrl}">${commentor}</a> /</span>`
                                : `<span> By Guest /</span>`;

                            // delete icon 
                            const delIcon = bloggerUrl ? `<i class="fas fa-trash delete-comment" data-id="${commentId}"></i>` : ``;

                            // append new comment
                            $("div.comments-list > span:nth-child(1)").after(
                                `
                            <div class="commented" id="comment-${commentId}">
                                    <i class="far fa-comment"></i>
                                    ${delIcon}
                                    ${urlLink}
                                    <span>${dateCreated}</span>
                                    <p id="comment">${content}</p>
                            </div>
                        `
                            );

                            countComments();

                            $('html, body').animate({
                                scrollTop: $(`#comment-${commentId}`).offset().top - 120
                            });
                            
                            // Rehydrate the page
                            $(".delete-comment").on('click', function()  {
                                const commentId = $(this).attr("data-id");

                                const userConfirm = confirm("Are you sure to delete this comment?");

                                if (!userConfirm) return;

                                $.ajax({
                                    type: "DELETE",
                                    url: `http://127.0.0.1:8000/post/ajax/comment/${commentId}/delete`,
                                    success: (response) => {
                                        $(`#comment-${commentId}`).remove();
                                        countComments();
                                    },
                                    error: ({error}) => {
                                        alert(data);
                                    }
                                })
                            });
                        },
                        error: function (data) {
                            // alert the error
                            alert(data["responseJSON"]["error"]);
                        },
                    });
                });

                $(".delete-comment").on('click', function()  {
                    const commentId = $(this).attr("data-id");

                    const userConfirm = confirm("Are you sure to delete this comment?");

                    if (!userConfirm) return;

                    $.ajax({
                        type: "DELETE",
                        url: `http://127.0.0.1:8000/post/ajax/comment/${commentId}/delete`,
                        success: (response) => {
                            $(`#comment-${commentId}`).remove();

                            countComments();
                        },
                        error: ({error}) => {
                            alert(data);
                        }
                    })
                });
            });
        </script>
    </body>
</html>
